<!DOCTYPE html>
<html lang="en">

<!-- Inscribe Editor v2 by Mark Yu -->

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inscribe Editor</title>

<!-- IBM Plex -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css"/>

<!-- Pyodide + CodeMirror scripts -->
<script defer data-cfasync="false" src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script defer data-cfasync="false" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script defer data-cfasync="false" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>

<style>
  :root{
    --bg:#fafaff;
    --surface:rgba(255,255,255,.88);
    --surfaceSolid:#fff;
    --panel:#ffffff;
    --panel2:#f9f9ff;

    --text:#0f172a;
    --muted:rgba(15,23,42,.65);
    --border:rgba(15,23,42,.12);

    --accent:#2563eb;
    --accentSoft:rgba(37,99,235,.12);

    --danger:#b42318;
    --dangerSoft:rgba(180,35,24,.10);

    --radius:12px;
    --radiusSm:10px;

    --shadow:0 10px 30px rgba(2,6,23,.08);
    --shadowHover:0 14px 40px rgba(2,6,23,.12);

    --ease:cubic-bezier(.2,.8,.2,1);
    --tFast:120ms;
    --tMed:180ms;

    --uiFont:15px;
    --btnH:36px;
    --iconBtn:34px;
    --hdrPadY:10px;
    --hdrPadX:14px;
    --mainPad:10px;
  }

  *{ box-sizing:border-box; margin:0; padding:0; }
  html,body{ height:100%; }

  body{
    font-family:"IBM Plex Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    font-size:var(--uiFont);
    line-height:1.6;
    color:var(--text);
    overflow:hidden;

    background:
      radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,0.10), transparent 55%),
      radial-gradient(900px 600px at 100% 0%, rgba(37,99,235,0.06), transparent 55%),
      var(--bg);
  }

  a{ color:inherit; text-decoration:none; }
  a:hover{ color:var(--accent); }

  ::-webkit-scrollbar{ width:10px; height:10px; }
  ::-webkit-scrollbar-track{ background:rgba(15,23,42,0.05); border-radius:999px; }
  ::-webkit-scrollbar-thumb{ background:rgba(15,23,42,0.18); border-radius:999px; }
  ::-webkit-scrollbar-thumb:hover{ background:rgba(15,23,42,0.26); }

  .app{
    height:100vh;
    display:flex;
    flex-direction:column;
    animation:appear var(--tMed) var(--ease) both;
  }
  @keyframes appear{
    from{ opacity:0; transform:translateY(4px); }
    to{ opacity:1; transform:translateY(0); }
  }

  header{
    position:sticky;
    top:0;
    z-index:20;
    background:var(--surface);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    border-bottom:1px solid var(--border);
  }

  .headerInner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:var(--hdrPadY) var(--hdrPadX);
  }

  .brand{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:220px;
    user-select:none;
  }
  .brand .material-icons{ font-size:18px; }

  .brandText{
    display:flex;
    flex-direction:column;
    gap:1px;
  }
  .brandText h1{
    font-size:15.5px;
    font-weight:600;
    letter-spacing:-0.01em;
    line-height:1.2;
  }
  .brandText .sub{
    font-size:12px;
    color:var(--muted);
  }

  .toolbar{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .toolBtn{
    height:var(--btnH);
    display:inline-flex;
    align-items:center;
    gap:8px;
    border-radius:var(--radiusSm);
    border:1px solid rgba(37,99,235,0.22);
    background:transparent;
    color:var(--accent);
    cursor:pointer;
    user-select:none;
    box-shadow:none;
    transition:
      background var(--tFast) var(--ease),
      box-shadow var(--tFast) var(--ease),
      border-color var(--tFast) var(--ease),
      max-width var(--tMed) var(--ease);
    padding:0 10px;
    white-space:nowrap;
  }

  .toolBtn:hover{
    background:var(--accentSoft);
    box-shadow:var(--shadowHover);
  }

  .toolBtn .material-icons{
    font-size:18px;
    line-height:1;
  }

  .toolBtn.collapse{
    max-width:40px;
    padding:0 10px;
    overflow:hidden;
  }

  .toolBtn.collapse:focus-visible,
  .toolBtn.collapse:focus-within{
    max-width:180px;
  }

  @media (hover:hover) and (pointer:fine){
    .toolBtn.collapse:hover{ max-width:180px; }
  }

  .toolLabel{
    opacity:0;
    transform:translateX(-2px);
    transition:opacity var(--tFast) var(--ease), transform var(--tFast) var(--ease);
  }

  .toolBtn.collapse:focus-visible .toolLabel,
  .toolBtn.collapse:focus-within .toolLabel{
    opacity:1;
    transform:translateX(0);
  }

  @media (hover:hover) and (pointer:fine){
    .toolBtn.collapse:hover .toolLabel{
      opacity:1;
      transform:translateX(0);
    }
  }

  .hintPill{
    margin-left:auto;
    font-family:"IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:11px;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid rgba(15,23,42,0.12);
    background:rgba(15,23,42,0.04);
    color:rgba(15,23,42,0.70);
    opacity:0;
    transform:translateX(-2px);
    transition:opacity var(--tFast) var(--ease), transform var(--tFast) var(--ease);
  }

  .toolBtn.collapse:focus-visible .hintPill{
    opacity:1;
    transform:translateX(0);
  }

  @media (hover:hover) and (pointer:fine){
    .toolBtn.collapse:hover .hintPill{
      opacity:1;
      transform:translateX(0);
    }
  }

  .toolBtn.primary{
    background:var(--accent);
    border-color:rgba(37,99,235,0.28);
    color:#fff;
    box-shadow:var(--shadow);
  }
  .toolBtn.primary:hover{
    box-shadow:var(--shadowHover);
    background:#1f55cf;
  }

  .toolBtn:disabled{
    opacity:0.55;
    cursor:not-allowed;
    box-shadow:none!important;
  }

  /* Split run group */
  .runGroup{
    display:inline-flex;
    align-items:center;
    gap:0;
    position:relative;
  }
  .runGroup #runBtn{
    border-top-right-radius:0;
    border-bottom-right-radius:0;
  }
  .runGroup #runModeBtn{
    width:40px;
    justify-content:center;
    padding:0;
    border-top-left-radius:0;
    border-bottom-left-radius:0;
    border-left:1px solid rgba(255,255,255,0.18);
  }

  /* Run meta: keep ONLY shortcut pill */
  .runMeta{
    margin-left:auto;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }

  .keyChip{
    font-family:"IBM Plex Mono";
    font-size:11px;
    padding:2px 8px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.28);
    background:transparent;
    color:rgba(255,255,255,0.92);
  }

  /* Menus */
  .menuWrap{ position:relative; }

  .menu{
    position:absolute;
    top:calc(100% + 8px);
    right:0;
    min-width:240px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(15,23,42,0.12);
    border-radius:14px;
    box-shadow:0 30px 80px rgba(2,6,23,0.20);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    padding:8px;
    display:none;
    z-index:40;
  }
  .menu.active{ display:block; animation:menuIn var(--tMed) var(--ease) both; }
  @keyframes menuIn{
    from{opacity:0; transform:translateY(6px);}
    to{opacity:1; transform:translateY(0);}
  }

  .menuItem{
    width:100%;
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid transparent;
    background:transparent;
    cursor:pointer;
    color:rgba(15,23,42,0.88);
    font-size:14px;
    transition:background var(--tFast) var(--ease);
  }
  .menuItem:hover{
    background:rgba(37,99,235,0.10);
  }
  .menuItem .material-icons{ font-size:18px; color:rgba(15,23,42,0.72); }
  .menuItem .miLabel{ flex:1; text-align:left; }
  .menuItem .miHint{
    font-family:"IBM Plex Mono";
    font-size:11px;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid rgba(15,23,42,0.12);
    background:rgba(15,23,42,0.04);
    color:rgba(15,23,42,0.70);
  }

  /* Run menu alignment fix */
  #runMenu{
    min-width:270px;
  }

  #runMenu .menuItem{
    display:grid;
    grid-template-columns:22px 1fr auto;
    align-items:center;
    column-gap:12px;
  }

  #runMenu .menuItem .material-icons{
    width:22px;
    justify-self:center;
  }

  #runMenu .miLabel{
    min-width:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  #runMenu .miHint{
    justify-self:end;
  }

  /* Right-side badges in run menu */
  #runMenu .miRight{
    display:inline-flex;
    align-items:center;
    gap:8px;
    justify-self:end;
  }

  /* Default badge stays only on Run All */
  #runMenu .defaultBadge{ display:none; }
  #runAllBtn .defaultBadge{ display:inline-flex; }

  /* Checkmark shows active mode */
  #runMenu .miCheck{
    display:none;
    font-size:18px;
    color:rgba(37,99,235,0.95);
  }
  #runMenu .menuItem.activeMode .miCheck{
    display:inline-block;
  }

  .menuItem.activeMode{
    background:rgba(37,99,235,0.12);
    border-color:rgba(37,99,235,0.20);
  }

  main{
    flex:1;
    min-height:0;
    overflow:hidden;
    padding:var(--mainPad);
  }

  .split{
    height:100%;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .pane{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    min-height:0;
    display:flex;
    flex-direction:column;
  }

  .paneHeader{
    padding:8px 10px;
    background:linear-gradient(to bottom, var(--panel2), rgba(255,255,255,0.80));
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .paneLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .paneTitle{
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:600;
    font-size:12.5px;
    letter-spacing:-0.01em;
    color:rgba(15,23,42,0.82);
    white-space:nowrap;
  }

  .dot{
    width:8px;height:8px;border-radius:999px;
    background:rgba(15,23,42,0.20);
  }

  .paneMeta{
    font-family:"IBM Plex Mono";
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:52vw;
  }

  .paneActions{
    display:flex;
    align-items:center;
    gap:6px;
    flex:none;
  }

  .iconBtn{
    width:var(--iconBtn);
    height:var(--iconBtn);
    border-radius:10px;
    border:1px solid rgba(15,23,42,0.10);
    background:rgba(15,23,42,0.03);
    color:rgba(15,23,42,0.72);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition:background var(--tFast) var(--ease);
  }
  .iconBtn:hover{ background:rgba(37,99,235,0.10); }

  .iconBtn.danger{
    border-color:rgba(180,35,24,0.18);
    background:rgba(180,35,24,0.06);
    color:var(--danger);
  }
  .iconBtn.danger:hover{ background:var(--dangerSoft); }

  .iconBtn.undo{
    border-color:rgba(37,99,235,0.22);
    background:rgba(37,99,235,0.08);
    color:var(--accent);
  }
  .iconBtn.undo:hover{ background:rgba(37,99,235,0.14); }

  .editorPane{ height:58%; }
  .consolePane{ flex:1; }

  .resizer{
    height:10px;
    border-radius:999px;
    cursor:row-resize;
    background:transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
  }
  .resizer::before{
    content:"";
    width:76px;
    height:4px;
    border-radius:999px;
    background:rgba(15,23,42,0.16);
    transition:background var(--tFast) var(--ease);
  }
  .resizer:hover::before{ background:rgba(15,23,42,0.26); }

  .CodeMirror,
  .CodeMirror pre,
  .CodeMirror-code{
    font-family:"IBM Plex Mono" !important;
  }
  .CodeMirror{
    height:100%;
    font-size:14px;
    line-height:1.56;
    background:#fff;
  }
  .CodeMirror-gutters{
    background:#fbfbfe;
    border-right:1px solid rgba(15,23,42,0.08);
  }
  .CodeMirror-linenumber{ color:rgba(15,23,42,0.42); }

  #console{
    flex:1;
    padding:10px;
    overflow:auto;
    background:#fff;
    font-family:"IBM Plex Mono";
    font-size:13.5px;
    line-height:1.55;
  }
  .consoleLine{
    margin-bottom:6px;
    white-space:pre-wrap;
    word-break:break-word;
    color:rgba(15,23,42,0.88);
  }
  .prefix{
    color:rgba(15,23,42,0.42);
    user-select:none;
    margin-right:6px;
  }
  .err{ color:var(--danger); }
  .dim{ color:rgba(15,23,42,0.62); }

  footer.statusbar{
    flex:none;
    border-top:1px solid var(--border);
    background:var(--surface);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    padding:7px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    user-select:none;
  }
  .sbLeft,.sbRight{
    display:inline-flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    min-width:0;
  }
  .sbItem{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    color:rgba(15,23,42,0.72);
    min-width:0;
  }
  .sbItem strong{
    font-family:"IBM Plex Mono";
    font-weight:400;
    color:rgba(15,23,42,0.85);
  }
  .sbDot{ width:6px;height:6px;border-radius:999px;background:rgba(15,23,42,0.30); }
  .good .sbDot{ background:rgba(16,185,129,0.75); }
  .warn .sbDot{ background:rgba(245,158,11,0.80); }
  .bad  .sbDot{ background:rgba(180,35,24,0.80); }

  .sbMono{
    font-family:"IBM Plex Mono";
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:40vw;
  }

  .overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.34);
    display:none;
    z-index:60;
    padding:16px;
    overflow:auto;
  }
  .overlay.active{
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .modal{
    width:min(820px, 96vw);
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(255,255,255,0.45);
    border-radius:16px;
    box-shadow:0 30px 80px rgba(2,6,23,0.28);
    padding:16px;
    overflow:visible;
    animation:modalIn var(--tMed) var(--ease) both;
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
  }
  @keyframes modalIn{
    from{ opacity:0; transform:translateY(6px); }
    to{ opacity:1; transform:translateY(0); }
  }
  .modal h2{
    font-size:16px;
    font-weight:600;
    letter-spacing:-0.015em;
    margin-bottom:6px;
  }
  .modal p{
    font-size:14px;
    color:rgba(15,23,42,0.82);
    margin-bottom:10px;
    line-height:1.6;
  }
  .modalRow{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
    margin-top:10px;
  }

  .prefs{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:8px;
  }
  .prefItem{
    border:1px solid rgba(15,23,42,0.10);
    background:rgba(15,23,42,0.03);
    border-radius:14px;
    padding:12px;
  }
  .prefTitle{
    font-size:12.5px;
    font-weight:600;
    letter-spacing:-0.01em;
    margin-bottom:8px;
    color:rgba(15,23,42,0.85);
  }
  .prefRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .prefRow label{
    font-size:14px;
    color:rgba(15,23,42,0.82);
    flex:1 1 180px;
  }
  .rangeWrap{
    display:inline-flex;
    align-items:center;
    gap:10px;
    flex:0 0 auto;
  }
  .rangeWrap input[type="range"]{
    width:clamp(140px, 26vw, 260px);
    accent-color:var(--accent);
  }
  .chip{
    font-family:"IBM Plex Mono";
    font-size:12px;
    padding:4px 8px;
    border-radius:10px;
    border:1px solid rgba(15,23,42,0.10);
    background:rgba(15,23,42,0.04);
    color:rgba(15,23,42,0.72);
    white-space:nowrap;
  }
  .toggle{
    display:inline-flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    user-select:none;
  }
  .toggle input{
    width:16px;height:16px;
    accent-color:var(--accent);
  }

  .shortcuts{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:14px;
  }
  .shortcuts td{
    padding:8px 8px;
    border-top:1px solid rgba(15,23,42,0.10);
    vertical-align:top;
  }
  .shortcuts tr:first-child td{ border-top:none; }
  .sKeys{
    width:240px;
    font-family:"IBM Plex Mono";
    color:rgba(15,23,42,0.88);
    white-space:nowrap;
  }
  kbd{
    font-family:"IBM Plex Mono";
    font-size:11px;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid rgba(15,23,42,0.12);
    background:rgba(15,23,42,0.04);
    color:rgba(15,23,42,0.82);
    margin-right:6px;
  }
  .sDesc{ color:rgba(15,23,42,0.70); }

  @media (max-width:820px){
    .brandText .sub{ display:none; }
    .paneMeta{ max-width:62vw; }
    .sbMono{ max-width:52vw; }
  }
</style>

<style id="dynamicStyles"></style>
</head>

<body>
  <div class="app">
    <header>
      <div class="headerInner">
        <div class="brand">
          <span class="material-icons" aria-hidden="true">code</span>
          <div class="brandText">
            <h1>Inscribe Editor</h1>
            <div class="sub">In-browser Python editor and executor.</div>
          </div>
        </div>

        <div class="toolbar">
          <!-- Run split button + config menu -->
          <div class="runGroup menuWrap" id="runGroup">
            <button class="toolBtn primary" id="runBtn" type="button" title="Run All (Cmd/Ctrl + Enter)">
              <span class="material-icons" aria-hidden="true">play_arrow</span>
              <span class="toolLabel" id="runLabel" style="opacity:1; transform:none;">Run All</span>

              <!-- Shortcut pill only -->
              <span class="runMeta">
                <span class="keyChip" id="hintRun">Ctrl Enter</span>
              </span>
            </button>

            <button class="toolBtn primary" id="runModeBtn" type="button" title="Run options"
              aria-haspopup="menu" aria-expanded="false">
              <span class="material-icons" aria-hidden="true">arrow_drop_down</span>
            </button>

            <div class="menu" id="runMenu" role="menu" aria-label="Run options">
              <button class="menuItem" id="runAllBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">description</span>
                <span class="miLabel">Run All</span>
                <span class="miRight" aria-hidden="true">
                  <span class="miHint defaultBadge">Default</span>
                  <span class="material-icons miCheck">done</span>
                </span>
              </button>

              <button class="menuItem" id="runSelBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">select_all</span>
                <span class="miLabel">Run Selection</span>
                <span class="miRight" aria-hidden="true">
                  <span class="miHint defaultBadge">Default</span>
                  <span class="material-icons miCheck">done</span>
                </span>
              </button>

              <button class="menuItem" id="runCellBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">view_agenda</span>
                <span class="miLabel">Run Cell</span>
                <span class="miRight" aria-hidden="true">
                  <span class="miHint defaultBadge">Default</span>
                  <span class="material-icons miCheck">done</span>
                </span>
              </button>
            </div>
          </div>

          <button class="toolBtn collapse" id="openBtn" type="button" title="Open (Cmd/Ctrl + O)" aria-label="Open file">
            <span class="material-icons" aria-hidden="true">folder_open</span>
            <span class="toolLabel">Open</span>
            <span class="hintPill" id="hintOpen">⌘ O</span>
          </button>

          <button class="toolBtn collapse" id="saveBtn" type="button" title="Save (Cmd/Ctrl + S)" aria-label="Save file">
            <span class="material-icons" aria-hidden="true">save</span>
            <span class="toolLabel">Save</span>
            <span class="hintPill" id="hintSave">⌘ S</span>
          </button>

          <div class="menuWrap">
            <button class="toolBtn collapse" id="moreBtn" type="button" aria-haspopup="menu" aria-expanded="false" title="More">
              <span class="material-icons" aria-hidden="true">more_horiz</span>
              <span class="toolLabel">More</span>
            </button>

            <div class="menu" id="moreMenu" role="menu" aria-label="More actions">
              <button class="menuItem" id="resetBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">restart_alt</span>
                <span class="miLabel">Reset</span>
              </button>

              <button class="menuItem" id="settingsBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">tune</span>
                <span class="miLabel">Settings</span>
                <span class="miHint" id="hintSettings">⌘ ,</span>
              </button>

              <button class="menuItem" id="aboutBtn" type="button" role="menuitem">
                <span class="material-icons" aria-hidden="true">info_outline</span>
                <span class="miLabel">About</span>
              </button>

              <a class="menuItem" role="menuitem" href="https://github.com/mkyyu/python-web-ide" target="_blank" rel="noreferrer">
                <span class="material-icons" aria-hidden="true">open_in_new</span>
                <span class="miLabel">View source</span>
              </a>
            </div>
          </div>

          <input type="file" id="fileInput" style="display:none;" accept=".py,.txt"/>
        </div>
      </div>
    </header>

    <main>
      <div class="split">
        <section class="pane editorPane" id="editorPane">
          <div class="paneHeader">
            <div class="paneLeft">
              <div class="paneTitle"><span class="dot"></span>Editor</div>
              <div class="paneMeta" id="fileMeta">untitled.py</div>
            </div>
            <div class="paneActions">
              <button class="iconBtn" id="wrapBtn" type="button" title="Toggle line wrap">
                <span class="material-icons" aria-hidden="true">wrap_text</span>
              </button>
            </div>
          </div>
          <textarea id="editor">print("Hello, World!")</textarea>
        </section>

        <div class="resizer" id="dragbar" aria-label="Resize panels"></div>

        <section class="pane consolePane" id="consolePane">
          <div class="paneHeader">
            <div class="paneLeft">
              <div class="paneTitle"><span class="dot"></span>Output</div>
            </div>
            <div class="paneActions">
              <button class="iconBtn danger" id="clearConsoleBtn" type="button" title="Clear console (Undo for 3s)">
                <span class="material-icons" aria-hidden="true">delete</span>
              </button>
              <button class="iconBtn undo" id="undoClearBtn" type="button" title="Undo clear" style="display:none;">
                <span class="material-icons" aria-hidden="true">undo</span>
              </button>
            </div>
          </div>
          <div id="console" role="log" aria-live="polite"></div>
        </section>
      </div>
    </main>

    <footer class="statusbar">
      <div class="sbLeft">
        <span class="sbItem good" id="sbRun"><span class="sbDot"></span><strong>Ready</strong></span>
        <span class="sbItem good" id="sbDirty"><span class="sbDot"></span><strong>Saved</strong></span>
        <span class="sbItem bad" id="sbPy"><span class="sbDot"></span><strong>Pyodide: not loaded</strong></span>
      </div>

      <div class="sbRight">
        <span class="sbItem"><strong class="sbMono" id="sbFile">untitled.py</strong></span>
        <span class="sbItem"><strong class="sbMono" id="sbPos">Ln 1, Col 1</strong></span>
        <span class="sbItem"><strong class="sbMono" id="sbSel">Sel 0</strong></span>
        <span class="sbItem"><strong class="sbMono" id="sbClock">--:--:--</strong></span>
      </div>
    </footer>
  </div>

  <!-- About modal -->
  <div class="overlay" id="aboutOverlay" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="modal">
      <h2 id="aboutTitle">Inscribe Editor</h2>
      <p>A lightweight in-browser Python editor and executor using Pyodide.</p>
      <p>
        This software comes with absolutely no warranty.<br/>
        Licensed under the MIT License.
      </p>
      <p style="color: rgba(15,23,42,0.70);">
        Copyright © 2023–2026 Mark Yu.
      </p>

      <div class="modalRow">
        <button class="toolBtn" id="closeAboutBtn" type="button">Close</button>
        <a class="toolBtn primary" href="https://github.com/mkyyu/python-web-ide" target="_blank" rel="noreferrer">
          <span class="material-icons" aria-hidden="true">open_in_new</span>
          <span style="opacity:1;transform:none;">View source</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <h2 id="settingsTitle">Settings</h2>
      <p>Quiet controls that improve long-session comfort. Stored locally in your browser.</p>

      <div class="prefs">
        <div class="prefItem">
          <div class="prefTitle">Font sizes</div>

          <div class="prefRow">
            <label for="editorSizeRange">Editor size</label>
            <div class="rangeWrap">
              <input id="editorSizeRange" type="range" min="12" max="18" step="0.25" />
              <span class="chip" id="editorSizeLabel">14.00px</span>
            </div>
          </div>

          <div style="height:10px;"></div>

          <div class="prefRow">
            <label for="consoleSizeRange">Console size</label>
            <div class="rangeWrap">
              <input id="consoleSizeRange" type="range" min="12" max="18" step="0.25" />
              <span class="chip" id="consoleSizeLabel">13.50px</span>
            </div>
          </div>
        </div>

        <div class="prefItem">
          <div class="prefTitle">Editor behavior</div>

          <div class="prefRow">
            <label class="toggle" for="wrapToggle">
              <input id="wrapToggle" type="checkbox" />
              <span>Line wrap</span>
            </label>

            <span class="paneMeta" style="max-width:none;">Also available from the editor header</span>
          </div>

          <div style="height:10px;"></div>

          <p style="margin-bottom:0;">
            <span class="paneMeta" style="max-width:none; white-space:normal;">
              Run selection if highlighted. Use <b># %%</b> to define cells.
            </span>
          </p>
        </div>

        <div class="prefItem">
          <div class="prefTitle">Shortcuts</div>
          <table class="shortcuts" aria-label="Keyboard shortcuts">
            <tbody id="shortcutBody"></tbody>
          </table>
        </div>
      </div>

      <div class="modalRow">
        <button class="toolBtn" id="closeSettingsBtn" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  window.addEventListener("error", (e) => {
    console.error("[Global error]", e.error || e.message);
  });
  window.addEventListener("unhandledrejection", (e) => {
    console.error("[Unhandled rejection]", e.reason);
  });

  function waitForGlobals(timeoutMs = 9000){
    return new Promise((resolve, reject) => {
      const start = performance.now();
      const tick = () => {
        const ok = !!(window.CodeMirror && window.loadPyodide);
        if (ok) return resolve();
        if (performance.now() - start > timeoutMs) {
          return reject(new Error("Dependencies not loaded: CodeMirror and/or Pyodide missing (CDN blocked / Rocket Loader / network)."));
        }
        requestAnimationFrame(tick);
      };
      tick();
    });
  }

  const safeLS = {
    get(key){
      try { return localStorage.getItem(key); } catch { return null; }
    },
    set(key, value){
      try { localStorage.setItem(key, value); } catch {}
    }
  };

  let booted = false;

  async function boot(){
    if (booted) return;
    booted = true;

    const consoleFallback = document.getElementById("console");
    const runBtnFallback = document.getElementById("runBtn");

    function showFatal(msg){
      console.error(msg);
      if (runBtnFallback) runBtnFallback.disabled = true;
      if (consoleFallback) {
        consoleFallback.innerHTML = "";
        const div = document.createElement("div");
        div.className = "consoleLine err";
        div.style.whiteSpace = "pre-wrap";
        div.textContent =
          "Editor failed to initialize.\n\n" +
          msg +
          "\n\nOpen DevTools → Console/Network for details.";
        consoleFallback.appendChild(div);
      } else {
        alert("Editor failed to initialize:\n\n" + msg);
      }
    }

    try{
      await waitForGlobals();
    }catch(err){
      showFatal(err?.message || String(err));
      return;
    }

    const LS = {
      DRAFT: "inscribe_draft_code_v5",
      PREFS: "inscribe_prefs_v5",
      FILENAME: "inscribe_filename_v5",
      RUNMODE: "inscribe_runmode_v5"
    };

    const runBtn = document.getElementById("runBtn");
    const runModeBtn = document.getElementById("runModeBtn");
    const runMenu = document.getElementById("runMenu");
    const runAllBtn = document.getElementById("runAllBtn");
    const runSelBtn = document.getElementById("runSelBtn");
    const runCellBtn = document.getElementById("runCellBtn");
    const runLabel = document.getElementById("runLabel");

    const openBtn = document.getElementById("openBtn");
    const saveBtn = document.getElementById("saveBtn");
    const fileInput = document.getElementById("fileInput");

    const moreBtn = document.getElementById("moreBtn");
    const moreMenu = document.getElementById("moreMenu");

    const resetBtn = document.getElementById("resetBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const aboutBtn = document.getElementById("aboutBtn");

    const wrapBtn = document.getElementById("wrapBtn");
    const editorPane = document.getElementById("editorPane");
    const resizer = document.getElementById("dragbar");
    const consoleEl = document.getElementById("console");

    const clearConsoleBtn = document.getElementById("clearConsoleBtn");
    const undoClearBtn = document.getElementById("undoClearBtn");

    const aboutOverlay = document.getElementById("aboutOverlay");
    const closeAboutBtn = document.getElementById("closeAboutBtn");
    const settingsOverlay = document.getElementById("settingsOverlay");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");

    const fileMeta = document.getElementById("fileMeta");
    const sbRun = document.getElementById("sbRun");
    const sbDirty = document.getElementById("sbDirty");
    const sbPy = document.getElementById("sbPy");
    const sbFile = document.getElementById("sbFile");
    const sbPos = document.getElementById("sbPos");
    const sbSel = document.getElementById("sbSel");
    const sbClock = document.getElementById("sbClock");

    const hintRun = document.getElementById("hintRun");
    const hintOpen = document.getElementById("hintOpen");
    const hintSave = document.getElementById("hintSave");
    const hintSettings = document.getElementById("hintSettings");

    const editorSizeRange = document.getElementById("editorSizeRange");
    const consoleSizeRange = document.getElementById("consoleSizeRange");
    const editorSizeLabel = document.getElementById("editorSizeLabel");
    const consoleSizeLabel = document.getElementById("consoleSizeLabel");
    const wrapToggle = document.getElementById("wrapToggle");
    const shortcutBody = document.getElementById("shortcutBody");

    const dynamicStyles = document.getElementById("dynamicStyles");

    const state = {
      isRunning: false,
      isDirty: false,
      pyodideReady: false,
      pyodideInstance: null,
      runMode: safeLS.get(LS.RUNMODE) || "all"
    };

    function debounce(fn, delay=200){
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), delay);
      };
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function addConsoleLine(text, opts={}){
      const line = document.createElement("div");
      line.className = "consoleLine";
      if (opts.error) line.classList.add("err");
      if (opts.dim) line.classList.add("dim");
      line.innerHTML = `<span class="prefix">&gt;</span>${escapeHtml(text)}`;
      consoleEl.appendChild(line);
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function clearConsole(keepBanner=true){
      consoleEl.innerHTML = "";
      if (keepBanner) addConsoleLine("Ready. Run to load Pyodide.", { dim:true });
    }

    function formatDuration(ms){
      if (!Number.isFinite(ms)) return "--";
      if (ms < 1000) return `${ms.toFixed(ms < 100 ? 1 : 0)} ms`;
      const s = ms / 1000;
      if (s < 60) return `${s.toFixed(s < 10 ? 2 : 1)} s`;
      const m = Math.floor(s / 60);
      const rem = s % 60;
      return `${m}m ${rem.toFixed(1)}s`;
    }

    function setClass(el, s){
      el.classList.remove("good","warn","bad");
      el.classList.add(s);
    }

    function updateStatusBar(){
      sbRun.innerHTML = `<span class="sbDot"></span><strong>${state.isRunning ? "Running" : "Ready"}</strong>`;
      setClass(sbRun, state.isRunning ? "warn" : "good");

      sbDirty.innerHTML = `<span class="sbDot"></span><strong>${state.isDirty ? "Unsaved" : "Saved"}</strong>`;
      setClass(sbDirty, state.isDirty ? "warn" : "good");

      sbPy.innerHTML = `<span class="sbDot"></span><strong>${state.pyodideReady ? "Pyodide: ready" : "Pyodide: not loaded"}</strong>`;
      setClass(sbPy, state.pyodideReady ? "good" : "bad");
    }

    const defaultPrefs = {
      editorFontSize: 14.00,
      consoleFontSize: 13.50,
      lineWrap: false
    };

    function loadPrefs(){
      try{
        const raw = safeLS.get(LS.PREFS);
        if (!raw) return { ...defaultPrefs };
        return { ...defaultPrefs, ...JSON.parse(raw) };
      }catch{
        return { ...defaultPrefs };
      }
    }

    function savePrefs(p){
      try { safeLS.set(LS.PREFS, JSON.stringify(p)); } catch {}
    }

    let prefs = loadPrefs();

    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      mode: "python",
      theme: "eclipse",
      lineNumbers: true,
      indentUnit: 4,
      matchBrackets: true,
      viewportMargin: Infinity,
      lineWrapping: !!prefs.lineWrap
    });

    function refocusEditor(){
      [openBtn, saveBtn, moreBtn, runModeBtn].forEach(b => b && b.blur());
      requestAnimationFrame(() => editor.focus());
    }

    function getRunModeLabel(mode){
      if (mode === "selection") return "Selection";
      if (mode === "cell") return "Cell";
      return "All";
    }

    function updateRunModeUI(){
      const label = getRunModeLabel(state.runMode);
      runLabel.textContent = `Run ${label}`;

      [runAllBtn, runSelBtn, runCellBtn].forEach(b => b.classList.remove("activeMode"));
      const map = { all: runAllBtn, selection: runSelBtn, cell: runCellBtn };
      const active = map[state.runMode];
      if (active) active.classList.add("activeMode");

      runBtn.title = `Run ${label} (Cmd/Ctrl + Enter)`;
    }

    function setRunMode(mode){
      const allowed = ["all","selection","cell"];
      state.runMode = allowed.includes(mode) ? mode : "all";
      safeLS.set(LS.RUNMODE, state.runMode);
      updateRunModeUI();
      addConsoleLine(`Run mode set to: ${getRunModeLabel(state.runMode)}`, { dim:true });
    }

    function getCurrentCellCode(){
      const cursor = editor.getCursor();
      const total = editor.lineCount();

      let startLine = 0;
      for (let i = cursor.line; i >= 0; i--) {
        if (editor.getLine(i).trim().startsWith("# %%")) {
          startLine = i + 1;
          break;
        }
      }

      let endLine = total;
      for (let i = cursor.line + 1; i < total; i++) {
        if (editor.getLine(i).trim().startsWith("# %%")) {
          endLine = i;
          break;
        }
      }

      return editor.getRange({ line:startLine, ch:0 }, { line:endLine, ch:0 });
    }

    function getCodeForMode(mode){
      if (mode === "cell") return getCurrentCellCode();

      if (mode === "selection") {
        if (!editor.somethingSelected()) return null;
        return editor.getSelection();
      }

      return editor.getValue();
    }

    let currentFilename = safeLS.get(LS.FILENAME) || "untitled.py";
    fileMeta.textContent = currentFilename;
    sbFile.textContent = currentFilename;

    function setFilename(name){
      currentFilename = name || "untitled.py";
      fileMeta.textContent = currentFilename;
      sbFile.textContent = currentFilename;
      safeLS.set(LS.FILENAME, currentFilename);
    }

    let lastSavedContent = editor.getValue();

    function setDirty(next){
      state.isDirty = !!next;
      updateStatusBar();
    }

    const saveDraftDebounced = debounce(() => {
      safeLS.set(LS.DRAFT, editor.getValue());
    }, 200);

    const draft = safeLS.get(LS.DRAFT);
    if (draft && draft.trim().length) {
      editor.setValue(draft);
      lastSavedContent = editor.getValue();
      setDirty(false);
      addConsoleLine("Restored previous draft.", { dim:true });
    }

    editor.on("change", () => {
      const curr = editor.getValue();
      setDirty(curr !== lastSavedContent);
      saveDraftDebounced();
    });

    window.addEventListener("beforeunload", (e) => {
      if (!state.isDirty) return;
      const msg = "You have unsaved code. Leave without saving?";
      e.preventDefault();
      e.returnValue = msg;
      return msg;
    });

    let consoleBackup = null;
    let undoTimer = null;

    function clearConsoleWithUndo(){
      if (undoTimer) clearTimeout(undoTimer);
      consoleBackup = consoleEl.innerHTML;

      consoleEl.innerHTML = "";
      addConsoleLine("Console cleared. Undo available for 3 seconds.", { dim:true });

      undoClearBtn.style.display = "inline-flex";
      undoTimer = setTimeout(() => {
        consoleBackup = null;
        undoClearBtn.style.display = "none";
      }, 3000);
    }

    function undoClearConsole(){
      if (!consoleBackup) return;
      if (undoTimer) clearTimeout(undoTimer);

      consoleEl.innerHTML = consoleBackup;
      consoleBackup = null;
      undoClearBtn.style.display = "none";
    }

    async function initializePyodide(){
      if (state.pyodideInstance) return;

      addConsoleLine("Loading Pyodide… This may take a moment on first run.", { dim:true });
      state.pyodideReady = false;
      updateStatusBar();

      state.pyodideInstance = await loadPyodide();

      state.pyodideInstance.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = sys.stdout
      `);

      await state.pyodideInstance.runPythonAsync(`
import builtins
def custom_input(prompt=""):
    from js import window
    return window.prompt(prompt)
builtins.input = custom_input
      `);

      state.pyodideReady = true;
      updateStatusBar();

      addConsoleLine("Inscribe Editor & Execution with Pyodide", { dim:true });
      addConsoleLine("Inscribe v2.1 / (c) Mark Yu, py.mkyu.one", { dim:true });
      addConsoleLine("------------------------------------------", { dim:true });
    }

    function resetEnvironment(){
      state.pyodideInstance = null;
      state.pyodideReady = false;
      addConsoleLine("Environment reset. Next run will reload Pyodide.", { dim:true });
      updateStatusBar();
      refocusEditor();
    }

    async function runCode(mode="all"){
      if (state.isRunning) return;
      state.isRunning = true;
      updateStatusBar();

      runBtn.disabled = true;
      runModeBtn.disabled = true;

      try{
        if (!state.pyodideInstance) await initializePyodide();

        const code = getCodeForMode(mode);
        if (!code || !code.trim()) {
          addConsoleLine(mode === "selection" ? "No selection to run." : "Nothing to run.", { dim:true });
          return;
        }

        addConsoleLine(`Executing (${getRunModeLabel(mode)})…`, { dim:true });

        const t0 = performance.now();
        await state.pyodideInstance.runPythonAsync(code);

        const output = state.pyodideInstance.runPython("sys.stdout.getvalue()");
        if (output && output.trim().length) {
          output.split("\n").forEach(line => {
            if (line.trim()) addConsoleLine(line);
          });
        }

        state.pyodideInstance.runPython("sys.stdout.truncate(0); sys.stdout.seek(0)");

        const dt = performance.now() - t0;
        addConsoleLine(`Finished in ${formatDuration(dt)}.`, { dim:true });

      } catch (err) {
        const msg = err?.toString?.() ?? String(err);
        msg.split("\n").forEach(l => {
          if (l.trim()) addConsoleLine(l, { error:true });
        });
        addConsoleLine("Finished with errors.", { dim:true });
      } finally {
        state.isRunning = false;
        updateStatusBar();
        runBtn.disabled = false;
        runModeBtn.disabled = false;
        refocusEditor();
      }
    }

    function runDefault(){
      return runCode(state.runMode);
    }

    function openFile(){
      openBtn.blur();
      fileInput.value = "";
      fileInput.click();
    }

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        addConsoleLine("Open cancelled.", { dim:true });
        refocusEditor();
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        editor.setValue(String(ev.target.result ?? ""));
        setFilename(file.name);
        lastSavedContent = editor.getValue();
        setDirty(false);
        addConsoleLine(`Loaded: ${file.name}`, { dim:true });
        refocusEditor();
      };
      reader.readAsText(file);
    });

    function saveFile(){
      saveBtn.blur();

      const code = editor.getValue();
      const blob = new Blob([code], { type:"text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = currentFilename || "script.py";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      lastSavedContent = code;
      setDirty(false);
      addConsoleLine(`Saved: ${a.download}`, { dim:true });

      refocusEditor();
    }

    function toggleWrap(){
      prefs.lineWrap = !prefs.lineWrap;
      savePrefs(prefs);
      applyPrefs();
      addConsoleLine(`Line wrap: ${prefs.lineWrap ? "on" : "off"}`, { dim:true });
      refocusEditor();
    }

    function openAbout(){ aboutOverlay.classList.add("active"); }
    function closeAbout(){ aboutOverlay.classList.remove("active"); }
    function openSettings(){ settingsOverlay.classList.add("active"); }
    function closeSettings(){ settingsOverlay.classList.remove("active"); }

    function closeAnyModal(){
      closeAbout();
      closeSettings();
    }

    aboutOverlay.addEventListener("click", (e) => { if (e.target === aboutOverlay) closeAbout(); });
    settingsOverlay.addEventListener("click", (e) => { if (e.target === settingsOverlay) closeSettings(); });

    function updateCursorStatus(){
      const c = editor.getCursor();
      sbPos.textContent = `Ln ${c.line + 1}, Col ${c.ch + 1}`;
      const selLen = editor.somethingSelected() ? editor.getSelection().length : 0;
      sbSel.textContent = `Sel ${selLen}`;
    }
    const updateCursorDebounced = debounce(updateCursorStatus, 40);
    editor.on("cursorActivity", updateCursorDebounced);

    function updateClock(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      sbClock.textContent = `${hh}:${mm}:${ss}`;
    }
    setInterval(updateClock, 1000);

    function isMac(){
      const p = navigator.platform || "";
      const ua = navigator.userAgent || "";
      return /Mac|iPhone|iPad|iPod/i.test(p) || /Mac OS X/i.test(ua);
    }

    function setHints(){
      const mac = isMac();
      const mod = mac ? "⌘" : "Ctrl";

      hintRun.textContent = `${mod} Enter`;
      hintOpen.textContent = `${mod} O`;
      hintSave.textContent = `${mod} S`;
      hintSettings.textContent = `${mod} ,`;

      const shortcuts = [
        { keys:[mod,"Enter"], desc:"Run (uses Run Mode config)" },
        { keys:[mod,"Shift","Enter"], desc:"Run current cell (# %%)" },
        { keys:[mod,"S"], desc:"Save file" },
        { keys:[mod,"O"], desc:"Open file" },
        { keys:[mod,","], desc:"Open Settings" },
        { keys:["Esc"], desc:"Close modals / menus" },
      ];

      shortcutBody.innerHTML = shortcuts.map(s=>{
        const keyHtml = s.keys.map(k=>`<kbd>${escapeHtml(k)}</kbd>`).join("");
        return `<tr><td class="sKeys">${keyHtml}</td><td class="sDesc">${escapeHtml(s.desc)}</td></tr>`;
      }).join("");
    }

    function isModKey(e){
      return e.metaKey || e.ctrlKey;
    }

    function openMenu(){
      closeRunMenu();
      moreMenu.classList.add("active");
      moreBtn.setAttribute("aria-expanded", "true");
    }
    function closeMenu(){
      moreMenu.classList.remove("active");
      moreBtn.setAttribute("aria-expanded", "false");
      moreBtn.blur();
    }
    function toggleMenu(){
      if (moreMenu.classList.contains("active")) closeMenu();
      else openMenu();
    }

    function openRunMenu(){
      closeMenu();
      runMenu.classList.add("active");
      runModeBtn.setAttribute("aria-expanded", "true");
    }
    function closeRunMenu(){
      runMenu.classList.remove("active");
      runModeBtn.setAttribute("aria-expanded", "false");
      runModeBtn.blur();
    }
    function toggleRunMenu(){
      if (runMenu.classList.contains("active")) closeRunMenu();
      else openRunMenu();
    }

    document.addEventListener("click", (e) => {
      const withinMore = moreMenu.contains(e.target) || moreBtn.contains(e.target);
      if (!withinMore) closeMenu();

      const withinRun = runMenu.contains(e.target) || runModeBtn.contains(e.target);
      if (!withinRun) closeRunMenu();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeAnyModal();
        closeMenu();
        closeRunMenu();
        refocusEditor();
        return;
      }

      if (!isModKey(e)) return;

      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        runDefault();
        return;
      }
      if (e.key === "Enter" && e.shiftKey) {
        e.preventDefault();
        runCode("cell");
        return;
      }
      if (e.key.toLowerCase() === "s") {
        e.preventDefault();
        saveFile();
        return;
      }
      if (e.key.toLowerCase() === "o") {
        e.preventDefault();
        openFile();
        return;
      }
      if (e.key === ",") {
        e.preventDefault();
        openSettings();
        return;
      }
    }, { passive:false });

    function applyPrefs(){
      dynamicStyles.textContent = `
        .CodeMirror{ font-size:${prefs.editorFontSize}px; }
        #console{ font-size:${prefs.consoleFontSize}px; }
      `;

      editor.setOption("lineWrapping", !!prefs.lineWrap);
      editor.refresh();

      editorSizeRange.value = prefs.editorFontSize;
      consoleSizeRange.value = prefs.consoleFontSize;
      editorSizeLabel.textContent = prefs.editorFontSize.toFixed(2) + "px";
      consoleSizeLabel.textContent = prefs.consoleFontSize.toFixed(2) + "px";
      wrapToggle.checked = !!prefs.lineWrap;
    }

    let dragging = false;
    let startY = 0;
    let startHeight = 0;

    resizer.addEventListener("mousedown", (e)=>{
      dragging = true;
      startY = e.clientY;
      startHeight = editorPane.offsetHeight;
      e.preventDefault();
    });

    document.addEventListener("mousemove", (e)=>{
      if (!dragging) return;

      const dy = e.clientY - startY;
      const split = document.querySelector(".split");
      const total = split.clientHeight;
      const min = 150;
      const max = total - 150;

      let next = startHeight + dy;
      if (next < min) next = min;
      if (next > max) next = max;

      editorPane.style.height = next + "px";
      editor.refresh();
    });

    document.addEventListener("mouseup", ()=>{ dragging = false; });

    runBtn.addEventListener("click", runDefault);
    runModeBtn.addEventListener("click", toggleRunMenu);

    runAllBtn.addEventListener("click", ()=> { setRunMode("all"); closeRunMenu(); refocusEditor(); });
    runSelBtn.addEventListener("click", ()=> { setRunMode("selection"); closeRunMenu(); refocusEditor(); });
    runCellBtn.addEventListener("click", ()=> { setRunMode("cell"); closeRunMenu(); refocusEditor(); });

    openBtn.addEventListener("click", openFile);
    saveBtn.addEventListener("click", saveFile);

    moreBtn.addEventListener("click", toggleMenu);

    resetBtn.addEventListener("click", ()=> { closeMenu(); resetEnvironment(); });
    settingsBtn.addEventListener("click", ()=> { closeMenu(); openSettings(); });
    aboutBtn.addEventListener("click", ()=> { closeMenu(); openAbout(); });

    wrapBtn.addEventListener("click", toggleWrap);

    clearConsoleBtn.addEventListener("click", clearConsoleWithUndo);
    undoClearBtn.addEventListener("click", undoClearConsole);

    closeAboutBtn.addEventListener("click", () => { closeAbout(); refocusEditor(); });
    closeSettingsBtn.addEventListener("click", () => { closeSettings(); refocusEditor(); });

    editorSizeRange.addEventListener("input", ()=>{
      prefs.editorFontSize = parseFloat(editorSizeRange.value);
      savePrefs(prefs);
      applyPrefs();
    });
    consoleSizeRange.addEventListener("input", ()=>{
      prefs.consoleFontSize = parseFloat(consoleSizeRange.value);
      savePrefs(prefs);
      applyPrefs();
    });
    wrapToggle.addEventListener("change", ()=>{
      prefs.lineWrap = !!wrapToggle.checked;
      savePrefs(prefs);
      applyPrefs();
    });

    clearConsole(true);
    setHints();
    applyPrefs();
    updateStatusBar();
    updateCursorStatus();
    updateClock();
    updateRunModeUI();
    refocusEditor();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>

</body>
</html>
